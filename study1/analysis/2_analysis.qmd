---
title: "InteroceptionScale - Data Analysis"
editor: source
editor_options: 
  chunk_output_type: console
format:
  html:
    code-fold: true
    self-contained: false
    toc: true
---


## Data Preparation

```{r}
#| message: false
#| warning: false

library(tidyverse)
library(easystats)
library(patchwork)
library(ggside)
library(EGAnet)
library(tidygraph)
library(ggraph)
```


```{r}
#| code-fold: false

df <- read.csv("../data/rawdata_participants.csv")

items <- select(df, contains("_Q")) 
byfacet <- items[df$Condition=="Dimensions",]
bymodality <- items[df$Condition=="Domains",]
byrandom <- items[df$Condition=="Random",]

# labels <- list(
#   Anxious_State_Q4 = "Blablagl re'f sdf",
#   sref
# )
# 
# Make 
```

## Item Correlation

::: {.panel-tabset}

### Full Sample

```{r}
#| fig-width: 12
#| fig-height: 12

make_heatmap <- function(items, interactive=TRUE, title="Correlation Matrix") {
  fn <- if(interactive) heatmaply::heatmaply else heatmaply::ggheatmap
  
  fn(
    cor(items),
    symm = TRUE,
    colors=heatmaply::cool_warm,
    show_dendrogram =c(FALSE, TRUE),
    main=title,
    showticklabels = FALSE,
    hide_colorbar = TRUE,
    k_col = 4,
    # k_row = 4,
    limits = c(-1, 1)
    )
}

# p1 <- make_heatmap(items, title="Full Sample")
# p1
```

### By Facet

Also "Dimension" / "Domains" / "Context"

```{r}
# p2 <- make_heatmap(byfacet, title="By Facet")
# p2
```

### By Modality

```{r}
# p3 <- make_heatmap(bymodality, title="By Modality")
# p3
```

### Random Grouping

```{r}
# p4 <- make_heatmap(byrandom, title="Random Grouping")
# p4
```


### Figures

```{r}
#| output: false

# p1 <- make_heatmap(items, interactive=FALSE) |>
#   gridExtra::arrangeGrob(top = 'Full Sample')
# p2 <- make_heatmap(byfacet, interactive=FALSE, title="By Facet") |>
#   gridExtra::arrangeGrob(top = 'By Facet')
# p3 <- make_heatmap(bymodality, interactive=FALSE, title="By Modality") |>
#   gridExtra::arrangeGrob(top = 'By Modality')
# p4 <- make_heatmap(byrandom, interactive=FALSE, title="Random Grouping") |>
#   gridExtra::arrangeGrob(top = 'Random Grouping')
```

```{r}
#| fig-width: 12
#| fig-height: 12

# gridExtra::grid.arrange(
#   p1, p2, p3, p4,
#   layout_matrix=rbind(
#     c(1,1,1),
#     c(1,1,1),
#     c(2,3, 4)))
```

:::


### Similarity

```{r}
# bootstrap_similarity <- function(df) {
#   rez <- data.frame()
#   for(i in 1:200) {
#     idx <- sample(1:nrow(df), nrow(df), replace=TRUE)
#     newdata <- df[idx,]
#     items <- select(df, contains("_Q"))
#     byfacet <- items[newdata$Condition=="Dimensions",]
#     bymodality <- items[newdata$Condition=="Domains",]
#     byrandom <- items[newdata$Condition=="Random",]
#     
#     rez <- rbind(
#       MatrixCorrelation::allCorrelations(cor(byrandom), cor(byfacet), 
#                                          ncomp1=10, ncomp2=10, plot=FALSE),
#       MatrixCorrelation::allCorrelations(cor(byrandom), cor(bymodality), 
#                                          ncomp1=10, ncomp2=10, plot=FALSE),
#       MatrixCorrelation::allCorrelations(cor(items), cor(byfacet),
#                                          ncomp1=10, ncomp2=10, plot=FALSE),
#       MatrixCorrelation::allCorrelations(cor(items), cor(bymodality), 
#                                          ncomp1=10, ncomp2=10, plot=FALSE)) |>
#       as.data.frame() |> 
#       mutate(
#         Comparison = c("Random vs. Facet", "Random vs. Modality", "Full vs. Facet", "Full vs. Modality"),
#         Sample = c("Random", "Random", "Full", "Full"),
#         Iteration = i) |> 
#       mutate(d_PSI = diff(PSI), d_RV = diff(RV), d_RVadj = diff(RVadj), d_SMI = diff(SMI), .by="Sample") |> 
#       rbind(rez)
#   }
#   rez
# }
# 
# 
# rez <- bootstrap_similarity(df)
# 
# rez |> 
#   pivot_longer(-c("Comparison", "Sample", "Iteration")) |> 
#   filter(name %in% c("PSI", "RV", "RVadj", "SMI")) |> 
#   mutate(side = ifelse(str_detect(Comparison, "Facet"), "left", "right")) |> 
#   ggplot(aes(x=name, y=value, fill=Comparison, color=Comparison)) +
#   ggdist::stat_halfeye(aes(side=side), position=position_dodge(width=0.3), alpha=0.7) +
#   facet_wrap(~Sample) +
#   scale_fill_manual(values=c("Random vs. Facet"="#F44336", "Random vs. Modality"="#2196F3", "Full vs. Facet"="#FF5722", "Full vs. Modality"="#00BCD4")) +
#   scale_color_manual(values=c("Random vs. Facet"="#F44336", "Random vs. Modality"="#2196F3", "Full vs. Facet"="#FF5722", "Full vs. Modality"="#00BCD4")) +
#   labs(x="Indices of Correlation Matrix Difference", y="Similarity") +
#   theme_minimal()
# 
# rez |> 
#   pivot_longer(-c("Comparison", "Sample", "Iteration")) |> 
#   filter(str_detect(name, "d_") & str_detect(Comparison, "Facet")) |> 
#   ggplot(aes(x=name, y=value)) +
#   ggdist::stat_eye(aes(fill = after_stat(y < 0))) +
#   facet_wrap(~Sample) +
#   geom_hline(yintercept=0, linetype="dashed") +
#   labs(x="Indices of Correlation Matrix Difference", y="Similarity Difference") +
#   theme_minimal() +
#   scale_fill_manual(values=c("TRUE"="#F44336", "FALSE"="#2196F3"), guide="none")
```

## Item Selection

### Unique Variable Analysis (UVA)

```{r}
uva <- EGAnet::UVA(items, cut.off = 0.2)
# uva

toremove_table <- rbind(
  data.frame(
  Condition = "Full Sample",
  Remove = uva$keep_remove$remove),
  data.frame(
  Condition = "By Facet",
  Remove = EGAnet::UVA(byfacet, cut.off = 0.2)$keep_remove$remove),
  data.frame(
  Condition = "By Modality",
  Remove = EGAnet::UVA(bymodality, cut.off = 0.2)$keep_remove$remove),
  data.frame(
  Condition = "Random Grouping",
  Remove = EGAnet::UVA(byrandom, cut.off = 0.2)$keep_remove$remove)
) |>
  mutate(n = n(), .by=c("Remove")) |>
  mutate(Condition = fct_relevel(Condition, "Full Sample", "By Facet", "By Modality", "Random Grouping")) |>
  arrange(desc(n), Remove, Condition)

toremove <- filter(toremove_table, Condition=="Full Sample" & n > 1)$Remove

toremove_table |>
  select(-n) |>
  gt::gt() |>
  gt::data_color(columns=Remove, fn=\(x) ifelse(x %in% toremove, "#FFEBEE", "white"))
```

```{r}
items <- select(items, -all_of(toremove))
byfacet <- select(byfacet, -all_of(toremove))
bymodality <- select(bymodality, -all_of(toremove))
byrandom <- select(byrandom, -all_of(toremove))
```

### Cluster Stability

```{r}
#| eval: false

ega1 <- bootEGA(
  items,
  EGA.type = "EGA",
  model = "glasso",  # BGGM
  algorithm = "louvain",  # walktrap
  type="resampling",
  plot.itemStability=FALSE,
  typicalStructure=TRUE,
  plot.typicalGraph=TRUE,
  iter=500,
  seed=3, ncores = 4)

save(ega1, file="models/ega1.RData")
```

```{r}
load("models/ega1.RData")

# EGAnet::dimensionStability(ega)
itemstability <- EGAnet::itemStability(ega1, IS.plot=FALSE)
plot(itemstability)

make_loadingtable <- function(x) {
  t <- as.data.frame(x) |>
    datawizard::data_addprefix("C")
  t$Cluster <- colnames(t)[max.col(t, ties.method='first')]
  
  t |>
    rownames_to_column(var="Item") |>
    rowwise() |>
    mutate(Max = max(c_across(-c(Item, Cluster)))) |>
    arrange(Cluster, desc(Max)) |> 
    as.data.frame()
}


itemstability_table <- make_loadingtable(itemstability$item.stability$all.dimensions) 

toremove2 <- filter(itemstability_table, Max < 0.7)$Item

itemstability_table |>
  select(-Cluster, -Max) |>
  gt::gt() |>
  gt::data_color(columns=-Item,
                 method = "numeric",
                 palette = c("white", "orange", "green"),
                 domain = c(0, 1)) |>
  gt::data_color(columns=Item, fn=\(x) ifelse(x %in% toremove2, "#FFEBEE", "white")) |>
  gt::tab_header(
    title = gt::md("**Item Stability**"),
    subtitle = "Proportion of times an item is assigned to the same cluster"
  )
```


```{r}
items <- select(items, -all_of(toremove2))
byfacet <- select(byfacet, -all_of(toremove2))
bymodality <- select(bymodality, -all_of(toremove2))
byrandom <- select(byrandom, -all_of(toremove2))
```

### Item Loadings



```{r}
#| eval: false

ega2 <- bootEGA(
  items,
  EGA.type = "hierEGA",
  model = "glasso",  # BGGM
  algorithm = "louvain",  # walktrap
  type="resampling",
  plot.itemStability=FALSE,
  typicalStructure=TRUE,
  plot.typicalGraph=TRUE,
  iter=500,
  seed=3, ncores = 4)

save(ega2, file="models/ega2.RData")
```

```{r}
load("models/ega2.RData")

# itemStability(ega2)

lower <- make_loadingtable(net.loads(ega2$EGA$lower_order)$std) 

toremove3 <- lower$Item[!lower$Item %in% slice_max(lower, Max, n=3, by="Cluster")$Item]

lower |>
  select(-Cluster, -Max) |>
  gt::gt() |>
  gt::data_color(columns=-Item,
                 method = "numeric",
                 palette = c("red", "white", "green"),
                 domain = c(-1, 1)) |>
  gt::data_color(columns=Item, fn=\(x) ifelse(x %in% toremove3, "#FFEBEE", "white")) |>
  gt::tab_header(
    title = gt::md("**Item Loadings**"),
    subtitle = "Node centrality"
  )
```

```{r}
items <- select(items, -all_of(toremove3))
byfacet <- select(byfacet, -all_of(toremove3))
bymodality <- select(bymodality, -all_of(toremove3))
byrandom <- select(byrandom, -all_of(toremove3))
```




## Structure Analysis


```{r}
#| eval: false

ega3 <- bootEGA(
  items,
  EGA.type = "hierEGA",
  model = "glasso",  # BGGM
  algorithm = "louvain",  # walktrap
  type="resampling",
  plot.itemStability=FALSE,
  typicalStructure=TRUE,
  plot.typicalGraph=TRUE,
  iter=500,
  seed=3, ncores = 4)

save(ega3, file="models/ega3.RData")
```

```{r}
load("models/ega3.RData")

# itemStability(ega2)

lower <- make_loadingtable(net.loads(ega3$EGA$lower_order)$std) 
higher <- make_loadingtable(t(net.loads(ega3$EGA$higher_order)$std)) |> 
  select(names(lower)) |> 
  arrange(Item)
higher$Item <- paste0("H", higher$Item) 

rbind(higher, lower) |>
  select(-Cluster, -Max) |>
  gt::gt() |>
  gt::tab_row_group(
    label = "Item",
    rows = 1:(nrow(lower) + nrow(higher))
  ) |>
  gt::tab_row_group(
    label = "Higher Order",
    rows = 1:nrow(higher)
  ) |> 
  gt::data_color(columns=-Item,
                 method = "numeric",
                 palette = c("red", "white", "green"),
                 domain = c(-1, 1)) |>
  gt::data_color(columns=Item, fn=\(x) ifelse(x %in% toremove3, "#FFEBEE", "white")) |>
  gt::tab_header(
    title = gt::md("**Item Loadings**"),
    subtitle = "Node centrality"
  )
```

```{r}
graph <- convert2tidygraph(ega3) 

tidygraph::tbl_graph(graph$nodes, edges=graph$edges, directed=FALSE) |>
  ggraph::ggraph(layout = 'graphopt') +
  ggraph::geom_edge_arc(aes(edge_color = link, edge_width = abs(link), edge_alpha=as.numeric(type == "real")), strength=0.1) +
  ggraph::geom_edge_arc(aes(edge_alpha=as.numeric(type == "virtual")), edge_width=0.1, strength=0) +
  ggraph::geom_node_point(aes(color=dimension, shape=level), size=10, alpha=0.7) +
  ggraph::geom_node_text(aes(label=name), repel=TRUE) +
  scale_edge_alpha(range = c(0, 0.9), guide="none") +
  scale_shape_manual(values=c("Higher"="square", "Lower"="circle")) +
  theme_void()
```





<!-- ::: {.panel-tabset} -->

<!-- ### Full Sample -->



<!-- ### By Dimension / Domains / Context -->

<!-- ```{r} -->
<!-- bydimension <- items[df$Condition=="Dimensions",] -->

<!-- ega_bydimension <- EGA(bydimension[, 1:20], plot.EGA = FALSE) -->

<!-- plot(ega_bydimension) -->
<!-- ``` -->

<!-- ### By Modalities -->

<!-- ```{r} -->
<!-- bymodality <- items[df$Condition=="Domains",] -->

<!-- ega_bymodality <- EGA(bymodality[, 1:20], plot.EGA = FALSE) -->

<!-- plot(ega_bymodality) -->
<!-- ``` -->

<!-- ::: -->

<!-- ## Model Comparison -->


<!-- ```{r} -->
<!-- EGAnet::EGM(items[, 1:60]) -->

<!-- # EGAnet::EGM.compare(items[, 1:20]) -->

<!-- rez <- EGAnet::network.compare(byfacet[, 1:20], bymodality[, 1:20], seed=3) -->
<!-- plot(rez) -->
<!-- ``` -->

### Empirical vs. Model Scores


```{r}
EGAnet::net.scores()
```
